---
name: Validate Kubernetes Manifests

on:
  pull_request:
    paths:
      - "k8s/**"
      - ".github/workflows/validate.yaml"
      - ".yamllint.yaml"

jobs:
  yamllint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install yamllint
        run: pip install yamllint
      - name: Run yamllint
        run: yamllint -c .yamllint.yaml k8s/

  kubeconform:
    name: Kubeconform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install kubeconform
        run: |
          curl -fsSL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin
      - name: Validate manifests
        run: |
          find k8s/ -name '*.yaml' -not -name 'values.yaml' -not -path 'k8s/longhorn/*' \
            | xargs kubeconform \
              -strict \
              -kubernetes-version 1.34.0 \
              -schema-location default \
              -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceVersion}}.json' \
              -skip ArgoCD,Application \
              -summary
